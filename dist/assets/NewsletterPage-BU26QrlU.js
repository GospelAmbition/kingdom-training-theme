import{j as e}from"./vendor-query-sc-3RV5c.js";import{r as d,L as z}from"./vendor-react-BsyC4uYt.js";import{P as U}from"./PageHeader-D-7p38kC.js";import{S as X}from"./SEO-BQWZoWKI.js";import{u as $,r as J}from"./main-Cm2q55zG.js";import{M as Y,e as w,f as G}from"./vendor-ui-BIzQpSM7.js";import"./vendor-helmet-BvUtKEoN.js";function oe(){const{t:r}=$(),[f,P]=d.useState(""),[b,L]=d.useState(!0),[y,o]=d.useState("idle"),[p,l]=d.useState(""),g=d.useRef(null);return d.useEffect(()=>{async function x(){try{const u=await J('[go_display_opt_in source="kt_news" name="Kingdom.Training"]');P(u)}catch(u){console.error("Error fetching shortcode:",u)}finally{L(!1)}}x()},[]),d.useEffect(()=>{var S,T;if(!f||b)return;const x=(S=g.current)==null?void 0:S.querySelector("form"),u=(T=g.current)==null?void 0:T.querySelector("#go-submit-form-button");if(!x||!u)return;const n=x;window.cf_token=null;const _="0x4AAAAAAA1dT7LSth0AgFDm",M=()=>new Promise(t=>{if(typeof window.turnstile<"u"){console.log("Turnstile API already loaded"),t();return}document.querySelectorAll('script[src*="challenges.cloudflare.com/turnstile"]').forEach(i=>{typeof window.turnstile>"u"&&i.remove()});const s=document.createElement("script");s.src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit",s.async=!0,s.onload=()=>{console.log("Turnstile script loaded successfully"),t()},s.onerror=i=>{console.error("Failed to load Turnstile script:",i),t()},document.head.appendChild(s)}),v=async()=>{if(console.log("Initializing Turnstile widget..."),await M(),typeof window.turnstile>"u"){console.error("Turnstile API not available after script load");return}let t=n.querySelector(".cf-turnstile");if(!t){console.log("Creating Turnstile widget container"),t=document.createElement("div"),t.className="cf-turnstile",t.id="turnstile-widget";const s=n.querySelector("#go-submit-form-button");s&&s.parentNode?s.parentNode.insertBefore(t,s):n.appendChild(t)}if(t.setAttribute("data-sitekey",_),t.setAttribute("data-theme","light"),t.querySelector("iframe")){console.log("Turnstile widget already rendered");return}t.innerHTML="";try{console.log("Rendering Turnstile widget with site key:",_);const s=window.turnstile.render(t,{sitekey:_,theme:"light",callback:i=>{console.log("Turnstile token received"),window.cf_token=i,typeof window.save_cf=="function"&&window.save_cf(i)},"error-callback":()=>{console.error("Turnstile widget error")},"expired-callback":()=>{console.log("Turnstile token expired"),window.cf_token=null}});console.log("Turnstile widget rendered, ID:",s)}catch(s){console.error("Error rendering Turnstile widget:",s)}},F=()=>{const t=n.querySelector(".cf-turnstile");if(!(t==null?void 0:t.getAttribute("data-sitekey"))){console.warn("Cloudflare Turnstile site key not configured");return}return typeof window.turnstile>"u"?(console.log("Waiting for Cloudflare Turnstile script to load..."),!1):(t==null?void 0:t.querySelector("iframe"))?!0:(console.log("Waiting for Cloudflare Turnstile widget to render..."),!1)};window.save_cf=function(t){console.log("save_cf called with token"),window.cf_token=t};const R=setTimeout(async()=>{await v(),setTimeout(()=>{F()||(console.warn("Turnstile widget may not have rendered properly. Retrying..."),v())},2e3)},200),H=()=>{var c;const t=(c=g.current)==null?void 0:c.querySelectorAll("script");if(!t)return null;for(const s of Array.from(t)){const m=(s.textContent||"").match(/X-WP-Nonce['"]:\s*['"]([^'"]+)['"]/);if(m)return m[1]}return null},K=()=>window.cf_token||null,k=async t=>{var c,s,i,m,A;t.preventDefault(),t.stopPropagation(),o("loading"),l("");try{const j=((c=n.querySelector('input[name="email2"]'))==null?void 0:c.value)||"",W=((s=n.querySelector('input[name="email"]'))==null?void 0:s.value)||"",B=((i=n.querySelector('input[name="first_name"]'))==null?void 0:i.value)||"",D=((m=n.querySelector('input[name="last_name"]'))==null?void 0:m.value)||"",O=(A=n.querySelector("#confirm-subscribe"))==null?void 0:A.checked;if(W)return;if(!O){o("error"),l(r("newsletter_confirm_subscribe"));return}const E=H(),C=K();if(!E){console.error("WordPress nonce not found"),o("error"),l(r("error_security_token_not_found"));return}const a=n.querySelector(".cf-turnstile"),q=a==null?void 0:a.getAttribute("data-sitekey");if(q&&!C){a&&a.offsetHeight>0&&a.offsetWidth>0?(o("error"),l(r("newsletter_security_complete"))):(o("error"),l(r("newsletter_security_loading"))),a&&a.scrollIntoView({behavior:"smooth",block:"center"});return}q||console.warn("Cloudflare Turnstile site key not configured. Form submission may fail on the server.");const N=n.getAttribute("action")||"/wp-json/go-webform/double-optin",V=N.startsWith("http")?N:`${window.location.origin}${N}`,I=await fetch(V,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":E},body:JSON.stringify({email:j,first_name:B,last_name:D,source:"kt_news",cf_turnstile:C})}),h=await I.json();I.ok&&h!==!1?(o("success"),l(r("newsletter_success_message")),n.reset()):(o("error"),l((h==null?void 0:h.message)||r("error_subscribe_generic")))}catch(j){console.error("Error submitting form:",j),o("error"),l(r("error_submit_failed"))}};return n.addEventListener("submit",k),()=>{clearTimeout(R),n.removeEventListener("submit",k)}},[f,b]),e.jsxs(e.Fragment,{children:[e.jsx(X,{title:r("page_newsletter"),description:r("seo_newsletter_description"),keywords:"kingdom training newsletter, M2DMM updates, disciple making newsletter, subscribe, training resources, ministry updates",url:"/newsletter",noindex:!0}),e.jsx(U,{title:r("page_newsletter"),description:r("page_newsletter_description"),backgroundClass:"bg-gradient-to-r from-primary-800 to-primary-600"}),e.jsx("section",{className:"py-16 bg-white",children:e.jsx("div",{className:"container-custom",children:e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs("div",{className:"bg-background-50 rounded-lg p-8 md:p-12 shadow-lg",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-primary-500 rounded-full mb-4",children:e.jsx(Y,{className:"w-8 h-8 text-white"})}),e.jsx("h2",{className:"text-3xl font-bold text-gray-900 mb-4",children:r("newsletter_subscribe_title")}),e.jsx("p",{className:"text-lg text-gray-700 leading-relaxed",children:r("newsletter_subscribe_description")})]}),b?e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"w-5 h-5 border-2 border-primary-500 border-t-transparent rounded-full animate-spin"})})}):f?e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:g,className:"mb-8",dangerouslySetInnerHTML:{__html:f}}),y==="loading"&&e.jsx("div",{className:"mb-6 bg-blue-50 border-2 border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-blue-800",children:r("ui_submitting_subscription")})]})}),y==="success"&&p&&e.jsx("div",{className:"mb-6 bg-green-50 border-2 border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(w,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-green-800",children:p})]})}),y==="error"&&p&&e.jsx("div",{className:"mb-6 bg-red-50 border-2 border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(G,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-red-800",children:p})]})})]}):null,e.jsxs("div",{className:"mt-8 pt-8 border-t border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:r("newsletter_what_to_expect")}),e.jsxs("ul",{className:"space-y-3 text-gray-700",children:[e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(w,{className:"w-5 h-5 text-primary-500 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:r("newsletter_expect_articles")})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(w,{className:"w-5 h-5 text-primary-500 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:r("newsletter_expect_tools")})]}),e.jsxs("li",{className:"flex items-start gap-3",children:[e.jsx(w,{className:"w-5 h-5 text-primary-500 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:r("newsletter_expect_stories")})]})]})]}),e.jsx("div",{className:"mt-6 text-sm text-gray-600 text-center",children:e.jsxs("p",{children:[r("newsletter_privacy_note"),e.jsx(z,{to:"/privacy",className:"text-primary-500 hover:text-primary-600 ml-1",children:r("newsletter_privacy_link")})]})})]})})})})]})}export{oe as default};
